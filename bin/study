#!/usr/bin/env node

const Answers = require('Answers');
const { load, sourceExpander } = require('../lib/load');
const { configSchema } = require('../lib/schema');
const path = require('path');
const callsites = require('callsites');
const { resolveTarget, jitInstall } = require('../lib/resolve');
const { inspect } = require('util');

(async () => {
    const calledFrom = callsites()[1].getFileName();
    const rawConfig = await Answers({
        name: 'incant',
        argv: process.argv.slice(2),
        loaders: [ sourceExpander ]
    });
    const config = await configSchema.validate(rawConfig);
    const { source } = config;
    const targets = await load({ patterns: source, cwd: path.dirname(calledFrom) });
    const targetName = config._[0];
    const target = resolveTarget(targets, targetName);
    if (target == null) throw new Error('no');
    let loader;
    try {
        const scoped = `@incant/${target.kind}-loader`;
        loader = jitInstall(scoped);
    } catch (e) {
        throw new Error(`${kind} is not a valid loader  - ${e.message}`);
    }
    const targetNameParts = targetName.split('.');
    const subcommand = targetNameParts.length > 1
        ? targetNameParts.slice(-1).join('.')
        : null;
    const configPaths = loader.study(target, { subcommand });
    console.log(inspect(configPaths, { depth: null, colors: true }));

})();
